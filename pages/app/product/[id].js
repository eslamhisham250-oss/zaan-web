// pages/app/product/[id].js
import { useRouter } from "next/router";
import { useEffect, useState } from "react";
import Footer from "../../../components/Footer";
import { addToCart } from "../../../lib/cart";

export default function ProductDetail() {
  const router = useRouter();
  const { id } = router.query;
  const [product, setProduct] = useState(null);
  const [mainImage, setMainImage] = useState("");
  const [selectedSize, setSelectedSize] = useState("");
  const [selectedColor, setSelectedColor] = useState("");

  // ููุชุฌุงุช ุงูุชุฑุงุถูุฉ (fallback)
  const fallbackProducts = [
    { 
      id: "1", 
      title: "ุณุฑูุฑ ุฎุดุจ ุทุจูุนู ูุน ุชุฎุฒูู", 
      price: 2500,
      oldPrice: 3000,
      image: "/images/bed_real.jpg", 
      images: ["/images/bed_real.jpg","/images/bed_real_side.jpg","/images/bed_real_size.jpg"],
      description: "ุณุฑูุฑ ุฎุดุจู ุฃููู ูุตููุน ูู ุฎุดุจ ุทุจูุนู ุนุงูู ุงูุฌูุฏุฉ ูุน ูุญุฏุฉ ุชุฎุฒูู ุณูููุฉ.",
      material: "ุฎุดุจ ุทุจูุนู + MDF",
      color: "ุจูู ุบุงูู",
      size: ["200x160 ุณู", "220x180 ุณู"],
      rating: 4.6,
      reviews: 180,
      shipping: "ูุตู ุฎูุงู 7 ุฃูุงู - ุดุญู ูุฌุงูู",
      returnPolicy: "ุฅุฑุฌุงุน ูุฌุงูู ุฎูุงู 14 ููู",
      warranty: "ุถูุงู ุณูุชูู ุนูู ุงูุฎุดุจ ูุงูุชุฌููุน",
      colors: ["#8B4513", "#444", "#D2B48C"],
      stock: 5,
      specs: {
        "ุจูุฏ ุงูุตูุน": "ูุตุฑ",
        "ุงููุฒู": "45 ูุฌู",
        "ุงูุฎุงูุฉ": "ุฎุดุจ ุทุจูุนู + MDF",
      },
      related: [
        { id:"2", title:"ุณุฑูุฑ ููุฏุฑู", image:"/images/bed2.jpg", price:2200 },
        { id:"3", title:"ุฏููุงุจ ุฎุดุจู", image:"/images/wardrobe.jpg", price:3200 },
      ],
      customerReviews: [
        { user:"ุฃุญูุฏ", rating:5, comment:"ููุชุฌ ููุชุงุฒ ูุฌูุฏุฉ ุนุงููุฉ ๐" },
        { user:"ููู", rating:4, comment:"ุญูู ุฌุฏุงู ุจุณ ุงูุดุญู ุงุชุฃุฎุฑ ููู" }
      ]
    }
  ];

  useEffect(() => {
    if (id) {
      fetch("/api/products")
        .then((r) => r.json())
        .then((data) => {
          let found = data.find((p) => String(p.id) === String(id));
          if (!found) found = fallbackProducts.find((p) => String(p.id) === String(id));
          setProduct(found);
          if (found?.images?.length) setMainImage(found.images[0]);
        })
        .catch(() => {
          const found = fallbackProducts.find((p) => String(p.id) === String(id));
          setProduct(found);
          if (found?.images?.length) setMainImage(found.images[0]);
        });
    }
  }, [id]);

  if (!product) return <p style={{ padding: 24 }}>โณ ุฌุงุฑู ุชุญููู ุงูููุชุฌ...</p>;

  return (
    <main style={{ maxWidth: 1100, margin: "0 auto", padding: 24 }} dir="rtl">
      {/* Breadcrumbs */}
      <div style={{ fontSize: 14, marginBottom: 12, color: "#666" }}>
        ุงูุฑุฆูุณูุฉ &gt; ุบุฑู ููู &gt; ุฃุณุฑุฉ &gt; <span style={{ color: "#0a7" }}>{product.title}</span>
      </div>

      {/* ุตูุฑ + ุชูุงุตูู ุฃุณุงุณูุฉ */}
      <div style={container}>
        <div style={imageBox}>
          {mainImage && (
            <img src={mainImage} alt={product.title} style={{ width: "75%", borderRadius: 12, margin: "0 auto", display: "block" }} />
          )}
          <div style={thumbs}>
            {product.images?.length > 0 ? product.images.map((img, i) => (
              <img key={i} src={img} alt={`preview-${i}`} style={{
                width: 70, height: 70, objectFit: "cover",
                borderRadius: 8, border: mainImage === img ? "2px solid #0a7" : "1px solid #ccc",
                cursor: "pointer"
              }} onClick={() => setMainImage(img)} />
            )) : <p style={{ color:"#888" }}>ูุง ุชูุฌุฏ ุตูุฑ ุฅุถุงููุฉ</p>}
          </div>
        </div>

        <div style={infoBox}>
          <h1>{product.title}</h1>
          <div style={{ display: "flex", gap: 12, alignItems: "center", marginBottom: 8 }}>
            <p style={{ fontSize: 24, fontWeight: "bold", color: "#0a7" }}>{product.price} ุฌ.ู</p>
            {product.oldPrice && (
              <>
                <p style={{ textDecoration: "line-through", color: "#888", fontSize: 16 }}>{product.oldPrice} ุฌ.ู</p>
                <span style={{ background: "#f33", color: "#fff", padding: "3px 8px", borderRadius: 6, fontSize: 13, fontWeight: "bold" }}>
                  -{Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100)}%
                </span>
              </>
            )}
          </div>
          <p style={{ fontSize: 13, color: "#666" }}>ุงูุณุนุฑ ุดุงูู ุงูุถุฑูุจุฉ</p>

          {/* Selling Points */}
          <div style={{ display: "flex", gap: 20, fontSize: 14, margin: "10px 0", color: "#444" }}>
            <div>๐ ุฏูุน ุขูู</div>
            <div>๐ ุดุญู ุณุฑูุน</div>
            <div>๐ก๏ธ ุถูุงู ูุนุชูุฏ</div>
          </div>

          {/* ุงููุฎุฒูู */}
          <p style={{ fontSize: 14, color: product.stock > 0 ? "#0a7" : "red" }}>
            {product.stock > 0 ? `ูุชุงุญ (${product.stock} ูุทุน)` : "ุบูุฑ ูุชุงุญ"}
          </p>

          {/* ููุงุณุงุช */}
          <div style={{ margin: "12px 0" }}>
            <b>ุงูููุงุณ:</b>
            <div style={{ display: "flex", gap: 8, marginTop: 6 }}>
              {Array.isArray(product.size) ? product.size.map((s, i) => (
                <button key={i} onClick={() => setSelectedSize(s)} style={{
                  padding: "6px 12px", borderRadius: 6,
                  border: selectedSize === s ? "2px solid #0a7" : "1px solid #ccc", cursor: "pointer"
                }}>
                  {s}
                </button>
              )) : <span>{product.size}</span>}
            </div>
          </div>

          {/* ุฃููุงู */}
          <div style={{ margin: "12px 0" }}>
            <b>ุงูุฃููุงู:</b>
            <div style={{ display: "flex", gap: 8, marginTop: 6 }}>
              {product.colors?.length > 0 ? product.colors.map((c, i) => (
                <span key={i} onClick={() => setSelectedColor(c)} style={{
                  width: 24, height: 24, borderRadius: "50%",
                  border: selectedColor === c ? "2px solid #0a7" : "1px solid #ccc",
                  background: c, cursor: "pointer"
                }}></span>
              )) : <p style={{ color:"#888" }}>ูุง ุชูุฌุฏ ุฃููุงู ูุชุงุญุฉ</p>}
            </div>
          </div>

          {/* ุฃุฒุฑุงุฑ */}
          <div style={{ display: "flex", gap: 12, marginTop: 12 }}>
            <button style={btn} onClick={() => { addToCart(product); alert("โ ุชูุช ุฅุถุงูุฉ ุงูููุชุฌ ุฅูู ุงูุนุฑุจุฉ"); }}>๐ ุฃุถู ุฅูู ุงูุนุฑุจุฉ</button>
            <button style={{ ...btn, background: "#f33" }}>๐ ุงุดุชุฑู ุงูุขู</button>
          </div>
        </div>
      </div>

      {/* ุงููุตู */}
      <section style={{ marginTop: 40 }}>
        <h2>ุงููุตู</h2>
        <p style={{ color:"#555", marginTop: 10 }}>{product.description || "ูุง ููุฌุฏ ูุตู ูุชุงุญ"}</p>
      </section>

      {/* ุงูููุงุตูุงุช */}
      <section style={{ marginTop: 40 }}>
        <h2>ุงูููุงุตูุงุช</h2>
        {product.specs ? (
          <table style={table}>
            <tbody>
              {Object.entries(product.specs).map(([k,v],i)=>(
                <tr key={i}><td>{k}</td><td>{v}</td></tr>
              ))}
            </tbody>
          </table>
        ) : (
          <p style={{ color:"#888" }}>ูุง ุชูุฌุฏ ููุงุตูุงุช ูุชุงุญุฉ ููุฐุง ุงูููุชุฌ</p>
        )}
      </section>

      {/* ุงูุชููููุงุช */}
      <section style={{ marginTop: 40 }}>
        <h2>ุงูุชููููุงุช</h2>
        {product.customerReviews?.length > 0 ? product.customerReviews.map((r,i)=>(
          <div key={i} style={reviewCard}>
            <b>{r.user}</b> โญ {r.rating}
            <p>{r.comment}</p>
          </div>
        )) : <p style={{ color:"#888" }}>ูุง ุชูุฌุฏ ุชููููุงุช ุญุงููุงู</p>}
      </section>

      {/* ููุชุฌุงุช ูุดุงุจูุฉ */}
      <section style={{ marginTop: 40 }}>
        <h2>ููุชุฌุงุช ูุดุงุจูุฉ</h2>
        <div style={similarBox}>
          {product.related?.length > 0 ? product.related.map((rp)=>(
            <div key={rp.id} style={similarItem}>
              <img src={rp.image} alt={rp.title} style={{ width:"100%", borderRadius:8, marginBottom:6 }} />
              <div>{rp.title}</div>
              <div style={{ color:"#0a7", fontWeight:"bold" }}>{rp.price} ุฌ.ู</div>
            </div>
          )) : <p style={{ color:"#888" }}>ูุง ุชูุฌุฏ ููุชุฌุงุช ูุดุงุจูุฉ</p>}
        </div>
      </section>

      {/* ูุดุงุฑูุฉ */}
      <section style={{ marginTop: 30 }}>
        <b>ุดุงุฑู ุงูููุชุฌ:</b>
        <div style={{ display:"flex", gap:12, marginTop:6 }}>
          <button style={shareBtn}>ูุงุชุณุงุจ</button>
          <button style={shareBtn}>ููุณุจูู</button>
          <button style={shareBtn}>ุชููุชุฑ</button>
        </div>
      </section>

      <Footer />
    </main>
  );
}

/* ===== Styles ===== */
const container = { display: "flex", gap: 24, flexWrap: "wrap" };
const imageBox = { flex: 1, minWidth: 320 };
const thumbs = { display: "flex", gap: 8, marginTop: 12, overflowX: "auto" };
const infoBox = { flex: 1, minWidth: 280 };
const btn = { background: "#0a7", color: "#fff", border: "none", borderRadius: 8, padding: "10px 18px", cursor: "pointer", fontSize: 16, fontWeight: "bold" };
const table = { width: "100%", borderCollapse: "collapse", fontSize: 14, color: "#333" };
const reviewCard = { background:"#f9f9f9", border:"1px solid #ddd", borderRadius:8, padding:12, marginBottom:10 };
const similarBox = { display:"flex", gap:12, marginTop:12, flexWrap:"wrap" };
const similarItem = { background:"#fff", border:"1px solid #ddd", borderRadius:8, padding:12, flex:"0 0 180px", textAlign:"center" };
const shareBtn = { background:"#eee", border:"1px solid #ccc", borderRadius:6, padding:"6px 12px", cursor:"pointer" };
